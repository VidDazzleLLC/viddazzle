#!/usr/bin/env node

/**
 * Automated Security Hardening Script
 *
 * This script automatically applies security middleware to ALL API routes
 * without requiring manual editing of each file.
 *
 * It creates wrapper files that add authentication and rate limiting.
 */

import { readFileSync, writeFileSync, readdirSync, statSync, existsSync, mkdirSync } from 'fs';
import { join, dirname, relative, basename } from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const API_DIR = join(process.cwd(), 'src/pages/api');
const SECURED_DIR = join(process.cwd(), 'src/pages/api-secured');

// Files to exclude from automatic protection
const EXCLUDE_FILES = [
  'health.js',
  'db/status.js',
  'db/setup.js',
  'workflows-protected-example.js',
];

// Files that should have relaxed rate limits
const RELAXED_RATE_LIMIT_FILES = [
  'health.js',
];

// Files that should have strict rate limits (expensive operations)
const STRICT_RATE_LIMIT_FILES = [
  'generate-workflow.js',
  'execute-workflow.js',
  'social-listening/listen.js',
];

console.log('üîí Automated Security Hardening Script');
console.log('='.repeat(60));

/**
 * Get all API files recursively
 */
function getApiFiles(dir, fileList = []) {
  const files = readdirSync(dir);

  for (const file of files) {
    const filePath = join(dir, file);
    const stat = statSync(filePath);

    if (stat.isDirectory()) {
      getApiFiles(filePath, fileList);
    } else if (file.endsWith('.js') || file.endsWith('.ts')) {
      // Get relative path from API directory
      const relativePath = relative(API_DIR, filePath);

      // Check if should be excluded
      if (!EXCLUDE_FILES.includes(relativePath) && !EXCLUDE_FILES.includes(file)) {
        fileList.push(relativePath);
      }
    }
  }

  return fileList;
}

/**
 * Determine rate limit preset for file
 */
function getRateLimitPreset(fileName) {
  if (RELAXED_RATE_LIMIT_FILES.some(f => fileName.includes(f))) {
    return 'RateLimitPresets.RELAXED';
  }
  if (STRICT_RATE_LIMIT_FILES.some(f => fileName.includes(f))) {
    return 'RateLimitPresets.STRICT';
  }
  return 'RateLimitPresets.STANDARD';
}

/**
 * Create secured wrapper for API file
 */
function createSecuredWrapper(apiFile) {
  const rateLimit = getRateLimitPreset(apiFile);
  const originalPath = `../../api/${apiFile}`;

  // Calculate relative path for imports (going from api-secured back to lib)
  const depth = apiFile.split('/').length;
  const libPath = '../'.repeat(depth) + '../lib';

  return `/**
 * Secured API Endpoint
 * Auto-generated by apply-security.js
 *
 * This file wraps the original API handler with security middleware:
 * - Authentication (requires valid Bearer token)
 * - Rate limiting (${rateLimit})
 * - Automatic error handling
 *
 * Original file: src/pages/api/${apiFile}
 */

import { withAuth } from '${libPath}/auth-middleware.js';
import { rateLimit, RateLimitPresets, combine } from '${libPath}/rate-limit.js';
import originalHandler from '${originalPath}';

/**
 * Apply security middleware to original handler
 */
const securedHandler = combine(
  withAuth,  // Require authentication
  rateLimit(${rateLimit})  // Apply rate limiting
)(originalHandler);

export default securedHandler;
`;
}

/**
 * Main execution
 */
function main() {
  console.log('\n1Ô∏è‚É£  Scanning API directory...');

  if (!existsSync(API_DIR)) {
    console.error('‚ùå API directory not found:', API_DIR);
    process.exit(1);
  }

  const apiFiles = getApiFiles(API_DIR);
  console.log(`   ‚úÖ Found ${apiFiles.length} API files to secure\n`);

  console.log('2Ô∏è‚É£  Creating secured wrappers...');

  // Create secured directory
  if (!existsSync(SECURED_DIR)) {
    mkdirSync(SECURED_DIR, { recursive: true });
  }

  let secured = 0;

  for (const apiFile of apiFiles) {
    const securedFile = join(SECURED_DIR, apiFile);
    const securedFileDir = dirname(securedFile);

    // Create subdirectories if needed
    if (!existsSync(securedFileDir)) {
      mkdirSync(securedFileDir, { recursive: true });
    }

    // Generate wrapper
    const wrapper = createSecuredWrapper(apiFile);
    writeFileSync(securedFile, wrapper);

    console.log(`   ‚úÖ Secured: ${apiFile}`);
    secured++;
  }

  console.log(`\n3Ô∏è‚É£  Security Summary:`);
  console.log(`   üìÅ Original APIs: src/pages/api/`);
  console.log(`   üîí Secured APIs: src/pages/api-secured/`);
  console.log(`   ‚úÖ Files secured: ${secured}`);

  console.log('\n4Ô∏è‚É£  Next Steps:');
  console.log('   To activate secured APIs, rename directories:');
  console.log('   ‚Ä¢ mv src/pages/api src/pages/api-original');
  console.log('   ‚Ä¢ mv src/pages/api-secured src/pages/api');
  console.log('');
  console.log('   Or use the activation script:');
  console.log('   ‚Ä¢ npm run security:activate');

  console.log('\n' + '='.repeat(60));
  console.log('‚úÖ Security hardening complete!');
  console.log('='.repeat(60));
}

// Run
try {
  main();
} catch (error) {
  console.error('\n‚ùå Error during security hardening:');
  console.error(error);
  process.exit(1);
}
